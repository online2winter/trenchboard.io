{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.scheduleAction = void 0;\nconst tslib_1 = require(\"tslib\");\nconst isArray = attempts => Array.isArray(attempts);\nconst abortedBySignal = () => new Error('Aborted by signal');\nconst abortedByDeadline = () => new Error('Aborted by deadline');\nconst abortedByTimeout = () => new Error('Aborted by timeout');\nconst resolveAfterMs = (ms, clear) => new Promise((resolve, reject) => {\n  if (clear.aborted) return reject();\n  if (ms === undefined) return resolve();\n  let timeout;\n  const onClear = () => {\n    clearTimeout(timeout);\n    clear.removeEventListener('abort', onClear);\n    reject();\n  };\n  timeout = setTimeout(() => {\n    clear.removeEventListener('abort', onClear);\n    resolve();\n  }, ms);\n  clear.addEventListener('abort', onClear);\n});\nconst rejectAfterMs = (ms, reason, clear) => new Promise((_, reject) => {\n  if (clear.aborted) return reject();\n  let timeout;\n  const onClear = () => {\n    clearTimeout(timeout);\n    clear.removeEventListener('abort', onClear);\n    reject();\n  };\n  timeout = setTimeout(() => {\n    clear.removeEventListener('abort', onClear);\n    reject(reason());\n  }, ms);\n  clear.addEventListener('abort', onClear);\n});\nconst maybeRejectAfterMs = (ms, reason, clear) => ms === undefined ? [] : [rejectAfterMs(ms, reason, clear)];\nconst rejectWhenAborted = (signal, clear) => new Promise((_, reject) => {\n  if (clear.aborted) return reject();\n  if (signal === null || signal === void 0 ? void 0 : signal.aborted) return reject(abortedBySignal());\n  const onAbort = () => reject(abortedBySignal());\n  signal === null || signal === void 0 ? void 0 : signal.addEventListener('abort', onAbort);\n  const onClear = () => {\n    signal === null || signal === void 0 ? void 0 : signal.removeEventListener('abort', onAbort);\n    clear.removeEventListener('abort', onClear);\n    reject();\n  };\n  clear.addEventListener('abort', onClear);\n});\nconst resolveAction = (action, clear) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n  const aborter = new AbortController();\n  if (clear.aborted) aborter.abort();\n  const onClear = () => {\n    clear.removeEventListener('abort', onClear);\n    aborter.abort();\n  };\n  clear.addEventListener('abort', onClear);\n  try {\n    return yield new Promise(resolve => resolve(action(aborter.signal)));\n  } finally {\n    if (!clear.aborted) clear.removeEventListener('abort', onClear);\n  }\n});\nconst attemptLoop = (attempts, attempt, failure, clear) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n  for (let a = 0; a < attempts - 1; a++) {\n    if (clear.aborted) break;\n    const aborter = new AbortController();\n    const onClear = () => aborter.abort();\n    clear.addEventListener('abort', onClear);\n    try {\n      return yield attempt(a, aborter.signal);\n    } catch (error) {\n      onClear();\n      yield failure(a, error);\n    } finally {\n      clear.removeEventListener('abort', onClear);\n    }\n  }\n  return clear.aborted ? Promise.reject() : attempt(attempts - 1, clear);\n});\nconst scheduleAction = (action, params) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n  const {\n    signal,\n    delay,\n    attempts,\n    timeout,\n    deadline,\n    gap,\n    attemptFailureHandler\n  } = params;\n  const deadlineMs = deadline && deadline - Date.now();\n  const attemptCount = isArray(attempts) ? attempts.length : attempts !== null && attempts !== void 0 ? attempts : deadline ? Infinity : 1;\n  const clearAborter = new AbortController();\n  const clear = clearAborter.signal;\n  const getParams = isArray(attempts) ? attempt => attempts[attempt] : () => ({\n    timeout,\n    gap\n  });\n  try {\n    return yield Promise.race([rejectWhenAborted(signal, clear), ...maybeRejectAfterMs(deadlineMs, abortedByDeadline, clear), resolveAfterMs(delay, clear).then(() => attemptLoop(attemptCount, (attempt, abort) => Promise.race([...maybeRejectAfterMs(getParams(attempt).timeout, abortedByTimeout, clear), resolveAction(action, abort)]), (attempt, error) => {\n      var _a;\n      const errorHandlerResult = attemptFailureHandler === null || attemptFailureHandler === void 0 ? void 0 : attemptFailureHandler(error);\n      return errorHandlerResult ? Promise.reject(errorHandlerResult) : resolveAfterMs((_a = getParams(attempt).gap) !== null && _a !== void 0 ? _a : 0, clear);\n    }, clear))]);\n  } finally {\n    clearAborter.abort();\n  }\n});\nexports.scheduleAction = scheduleAction;","map":{"version":3,"names":["Object","defineProperty","exports","value","scheduleAction","tslib_1","require","isArray","attempts","Array","abortedBySignal","Error","abortedByDeadline","abortedByTimeout","resolveAfterMs","ms","clear","Promise","resolve","reject","aborted","undefined","timeout","onClear","clearTimeout","removeEventListener","setTimeout","addEventListener","rejectAfterMs","reason","_","maybeRejectAfterMs","rejectWhenAborted","signal","onAbort","resolveAction","action","__awaiter","aborter","AbortController","abort","attemptLoop","attempt","failure","a","error","params","delay","deadline","gap","attemptFailureHandler","deadlineMs","Date","now","attemptCount","length","Infinity","clearAborter","getParams","race","then","_a","errorHandlerResult"],"sources":["/Users/papa/Desktop/trenchboard/trenchboard.io/node_modules/@trezor/utils/lib/scheduleAction.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.scheduleAction = void 0;\nconst tslib_1 = require(\"tslib\");\nconst isArray = (attempts) => Array.isArray(attempts);\nconst abortedBySignal = () => new Error('Aborted by signal');\nconst abortedByDeadline = () => new Error('Aborted by deadline');\nconst abortedByTimeout = () => new Error('Aborted by timeout');\nconst resolveAfterMs = (ms, clear) => new Promise((resolve, reject) => {\n    if (clear.aborted)\n        return reject();\n    if (ms === undefined)\n        return resolve();\n    let timeout;\n    const onClear = () => {\n        clearTimeout(timeout);\n        clear.removeEventListener('abort', onClear);\n        reject();\n    };\n    timeout = setTimeout(() => {\n        clear.removeEventListener('abort', onClear);\n        resolve();\n    }, ms);\n    clear.addEventListener('abort', onClear);\n});\nconst rejectAfterMs = (ms, reason, clear) => new Promise((_, reject) => {\n    if (clear.aborted)\n        return reject();\n    let timeout;\n    const onClear = () => {\n        clearTimeout(timeout);\n        clear.removeEventListener('abort', onClear);\n        reject();\n    };\n    timeout = setTimeout(() => {\n        clear.removeEventListener('abort', onClear);\n        reject(reason());\n    }, ms);\n    clear.addEventListener('abort', onClear);\n});\nconst maybeRejectAfterMs = (ms, reason, clear) => ms === undefined ? [] : [rejectAfterMs(ms, reason, clear)];\nconst rejectWhenAborted = (signal, clear) => new Promise((_, reject) => {\n    if (clear.aborted)\n        return reject();\n    if (signal === null || signal === void 0 ? void 0 : signal.aborted)\n        return reject(abortedBySignal());\n    const onAbort = () => reject(abortedBySignal());\n    signal === null || signal === void 0 ? void 0 : signal.addEventListener('abort', onAbort);\n    const onClear = () => {\n        signal === null || signal === void 0 ? void 0 : signal.removeEventListener('abort', onAbort);\n        clear.removeEventListener('abort', onClear);\n        reject();\n    };\n    clear.addEventListener('abort', onClear);\n});\nconst resolveAction = (action, clear) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n    const aborter = new AbortController();\n    if (clear.aborted)\n        aborter.abort();\n    const onClear = () => {\n        clear.removeEventListener('abort', onClear);\n        aborter.abort();\n    };\n    clear.addEventListener('abort', onClear);\n    try {\n        return yield new Promise(resolve => resolve(action(aborter.signal)));\n    }\n    finally {\n        if (!clear.aborted)\n            clear.removeEventListener('abort', onClear);\n    }\n});\nconst attemptLoop = (attempts, attempt, failure, clear) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n    for (let a = 0; a < attempts - 1; a++) {\n        if (clear.aborted)\n            break;\n        const aborter = new AbortController();\n        const onClear = () => aborter.abort();\n        clear.addEventListener('abort', onClear);\n        try {\n            return yield attempt(a, aborter.signal);\n        }\n        catch (error) {\n            onClear();\n            yield failure(a, error);\n        }\n        finally {\n            clear.removeEventListener('abort', onClear);\n        }\n    }\n    return clear.aborted ? Promise.reject() : attempt(attempts - 1, clear);\n});\nconst scheduleAction = (action, params) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {\n    const { signal, delay, attempts, timeout, deadline, gap, attemptFailureHandler } = params;\n    const deadlineMs = deadline && deadline - Date.now();\n    const attemptCount = isArray(attempts)\n        ? attempts.length\n        : attempts !== null && attempts !== void 0 ? attempts : (deadline ? Infinity : 1);\n    const clearAborter = new AbortController();\n    const clear = clearAborter.signal;\n    const getParams = isArray(attempts)\n        ? (attempt) => attempts[attempt]\n        : () => ({ timeout, gap });\n    try {\n        return yield Promise.race([\n            rejectWhenAborted(signal, clear),\n            ...maybeRejectAfterMs(deadlineMs, abortedByDeadline, clear),\n            resolveAfterMs(delay, clear).then(() => attemptLoop(attemptCount, (attempt, abort) => Promise.race([\n                ...maybeRejectAfterMs(getParams(attempt).timeout, abortedByTimeout, clear),\n                resolveAction(action, abort),\n            ]), (attempt, error) => {\n                var _a;\n                const errorHandlerResult = attemptFailureHandler === null || attemptFailureHandler === void 0 ? void 0 : attemptFailureHandler(error);\n                return errorHandlerResult\n                    ? Promise.reject(errorHandlerResult)\n                    : resolveAfterMs((_a = getParams(attempt).gap) !== null && _a !== void 0 ? _a : 0, clear);\n            }, clear)),\n        ]);\n    }\n    finally {\n        clearAborter.abort();\n    }\n});\nexports.scheduleAction = scheduleAction;\n//# sourceMappingURL=scheduleAction.js.map"],"mappings":"AAAA,YAAY;;AACZA,MAAM,CAACC,cAAc,CAACC,OAAO,EAAE,YAAY,EAAE;EAAEC,KAAK,EAAE;AAAK,CAAC,CAAC;AAC7DD,OAAO,CAACE,cAAc,GAAG,KAAK,CAAC;AAC/B,MAAMC,OAAO,GAAGC,OAAO,CAAC,OAAO,CAAC;AAChC,MAAMC,OAAO,GAAIC,QAAQ,IAAKC,KAAK,CAACF,OAAO,CAACC,QAAQ,CAAC;AACrD,MAAME,eAAe,GAAGA,CAAA,KAAM,IAAIC,KAAK,CAAC,mBAAmB,CAAC;AAC5D,MAAMC,iBAAiB,GAAGA,CAAA,KAAM,IAAID,KAAK,CAAC,qBAAqB,CAAC;AAChE,MAAME,gBAAgB,GAAGA,CAAA,KAAM,IAAIF,KAAK,CAAC,oBAAoB,CAAC;AAC9D,MAAMG,cAAc,GAAGA,CAACC,EAAE,EAAEC,KAAK,KAAK,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;EACnE,IAAIH,KAAK,CAACI,OAAO,EACb,OAAOD,MAAM,CAAC,CAAC;EACnB,IAAIJ,EAAE,KAAKM,SAAS,EAChB,OAAOH,OAAO,CAAC,CAAC;EACpB,IAAII,OAAO;EACX,MAAMC,OAAO,GAAGA,CAAA,KAAM;IAClBC,YAAY,CAACF,OAAO,CAAC;IACrBN,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3CJ,MAAM,CAAC,CAAC;EACZ,CAAC;EACDG,OAAO,GAAGI,UAAU,CAAC,MAAM;IACvBV,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3CL,OAAO,CAAC,CAAC;EACb,CAAC,EAAEH,EAAE,CAAC;EACNC,KAAK,CAACW,gBAAgB,CAAC,OAAO,EAAEJ,OAAO,CAAC;AAC5C,CAAC,CAAC;AACF,MAAMK,aAAa,GAAGA,CAACb,EAAE,EAAEc,MAAM,EAAEb,KAAK,KAAK,IAAIC,OAAO,CAAC,CAACa,CAAC,EAAEX,MAAM,KAAK;EACpE,IAAIH,KAAK,CAACI,OAAO,EACb,OAAOD,MAAM,CAAC,CAAC;EACnB,IAAIG,OAAO;EACX,MAAMC,OAAO,GAAGA,CAAA,KAAM;IAClBC,YAAY,CAACF,OAAO,CAAC;IACrBN,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3CJ,MAAM,CAAC,CAAC;EACZ,CAAC;EACDG,OAAO,GAAGI,UAAU,CAAC,MAAM;IACvBV,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3CJ,MAAM,CAACU,MAAM,CAAC,CAAC,CAAC;EACpB,CAAC,EAAEd,EAAE,CAAC;EACNC,KAAK,CAACW,gBAAgB,CAAC,OAAO,EAAEJ,OAAO,CAAC;AAC5C,CAAC,CAAC;AACF,MAAMQ,kBAAkB,GAAGA,CAAChB,EAAE,EAAEc,MAAM,EAAEb,KAAK,KAAKD,EAAE,KAAKM,SAAS,GAAG,EAAE,GAAG,CAACO,aAAa,CAACb,EAAE,EAAEc,MAAM,EAAEb,KAAK,CAAC,CAAC;AAC5G,MAAMgB,iBAAiB,GAAGA,CAACC,MAAM,EAAEjB,KAAK,KAAK,IAAIC,OAAO,CAAC,CAACa,CAAC,EAAEX,MAAM,KAAK;EACpE,IAAIH,KAAK,CAACI,OAAO,EACb,OAAOD,MAAM,CAAC,CAAC;EACnB,IAAIc,MAAM,KAAK,IAAI,IAAIA,MAAM,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAGA,MAAM,CAACb,OAAO,EAC9D,OAAOD,MAAM,CAACT,eAAe,CAAC,CAAC,CAAC;EACpC,MAAMwB,OAAO,GAAGA,CAAA,KAAMf,MAAM,CAACT,eAAe,CAAC,CAAC,CAAC;EAC/CuB,MAAM,KAAK,IAAI,IAAIA,MAAM,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAGA,MAAM,CAACN,gBAAgB,CAAC,OAAO,EAAEO,OAAO,CAAC;EACzF,MAAMX,OAAO,GAAGA,CAAA,KAAM;IAClBU,MAAM,KAAK,IAAI,IAAIA,MAAM,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAGA,MAAM,CAACR,mBAAmB,CAAC,OAAO,EAAES,OAAO,CAAC;IAC5FlB,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3CJ,MAAM,CAAC,CAAC;EACZ,CAAC;EACDH,KAAK,CAACW,gBAAgB,CAAC,OAAO,EAAEJ,OAAO,CAAC;AAC5C,CAAC,CAAC;AACF,MAAMY,aAAa,GAAGA,CAACC,MAAM,EAAEpB,KAAK,KAAKX,OAAO,CAACgC,SAAS,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,aAAa;EAC5F,MAAMC,OAAO,GAAG,IAAIC,eAAe,CAAC,CAAC;EACrC,IAAIvB,KAAK,CAACI,OAAO,EACbkB,OAAO,CAACE,KAAK,CAAC,CAAC;EACnB,MAAMjB,OAAO,GAAGA,CAAA,KAAM;IAClBP,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC3Ce,OAAO,CAACE,KAAK,CAAC,CAAC;EACnB,CAAC;EACDxB,KAAK,CAACW,gBAAgB,CAAC,OAAO,EAAEJ,OAAO,CAAC;EACxC,IAAI;IACA,OAAO,MAAM,IAAIN,OAAO,CAACC,OAAO,IAAIA,OAAO,CAACkB,MAAM,CAACE,OAAO,CAACL,MAAM,CAAC,CAAC,CAAC;EACxE,CAAC,SACO;IACJ,IAAI,CAACjB,KAAK,CAACI,OAAO,EACdJ,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;EACnD;AACJ,CAAC,CAAC;AACF,MAAMkB,WAAW,GAAGA,CAACjC,QAAQ,EAAEkC,OAAO,EAAEC,OAAO,EAAE3B,KAAK,KAAKX,OAAO,CAACgC,SAAS,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,aAAa;EAC9G,KAAK,IAAIO,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGpC,QAAQ,GAAG,CAAC,EAAEoC,CAAC,EAAE,EAAE;IACnC,IAAI5B,KAAK,CAACI,OAAO,EACb;IACJ,MAAMkB,OAAO,GAAG,IAAIC,eAAe,CAAC,CAAC;IACrC,MAAMhB,OAAO,GAAGA,CAAA,KAAMe,OAAO,CAACE,KAAK,CAAC,CAAC;IACrCxB,KAAK,CAACW,gBAAgB,CAAC,OAAO,EAAEJ,OAAO,CAAC;IACxC,IAAI;MACA,OAAO,MAAMmB,OAAO,CAACE,CAAC,EAAEN,OAAO,CAACL,MAAM,CAAC;IAC3C,CAAC,CACD,OAAOY,KAAK,EAAE;MACVtB,OAAO,CAAC,CAAC;MACT,MAAMoB,OAAO,CAACC,CAAC,EAAEC,KAAK,CAAC;IAC3B,CAAC,SACO;MACJ7B,KAAK,CAACS,mBAAmB,CAAC,OAAO,EAAEF,OAAO,CAAC;IAC/C;EACJ;EACA,OAAOP,KAAK,CAACI,OAAO,GAAGH,OAAO,CAACE,MAAM,CAAC,CAAC,GAAGuB,OAAO,CAAClC,QAAQ,GAAG,CAAC,EAAEQ,KAAK,CAAC;AAC1E,CAAC,CAAC;AACF,MAAMZ,cAAc,GAAGA,CAACgC,MAAM,EAAEU,MAAM,KAAKzC,OAAO,CAACgC,SAAS,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,aAAa;EAC9F,MAAM;IAAEJ,MAAM;IAAEc,KAAK;IAAEvC,QAAQ;IAAEc,OAAO;IAAE0B,QAAQ;IAAEC,GAAG;IAAEC;EAAsB,CAAC,GAAGJ,MAAM;EACzF,MAAMK,UAAU,GAAGH,QAAQ,IAAIA,QAAQ,GAAGI,IAAI,CAACC,GAAG,CAAC,CAAC;EACpD,MAAMC,YAAY,GAAG/C,OAAO,CAACC,QAAQ,CAAC,GAChCA,QAAQ,CAAC+C,MAAM,GACf/C,QAAQ,KAAK,IAAI,IAAIA,QAAQ,KAAK,KAAK,CAAC,GAAGA,QAAQ,GAAIwC,QAAQ,GAAGQ,QAAQ,GAAG,CAAE;EACrF,MAAMC,YAAY,GAAG,IAAIlB,eAAe,CAAC,CAAC;EAC1C,MAAMvB,KAAK,GAAGyC,YAAY,CAACxB,MAAM;EACjC,MAAMyB,SAAS,GAAGnD,OAAO,CAACC,QAAQ,CAAC,GAC5BkC,OAAO,IAAKlC,QAAQ,CAACkC,OAAO,CAAC,GAC9B,OAAO;IAAEpB,OAAO;IAAE2B;EAAI,CAAC,CAAC;EAC9B,IAAI;IACA,OAAO,MAAMhC,OAAO,CAAC0C,IAAI,CAAC,CACtB3B,iBAAiB,CAACC,MAAM,EAAEjB,KAAK,CAAC,EAChC,GAAGe,kBAAkB,CAACoB,UAAU,EAAEvC,iBAAiB,EAAEI,KAAK,CAAC,EAC3DF,cAAc,CAACiC,KAAK,EAAE/B,KAAK,CAAC,CAAC4C,IAAI,CAAC,MAAMnB,WAAW,CAACa,YAAY,EAAE,CAACZ,OAAO,EAAEF,KAAK,KAAKvB,OAAO,CAAC0C,IAAI,CAAC,CAC/F,GAAG5B,kBAAkB,CAAC2B,SAAS,CAAChB,OAAO,CAAC,CAACpB,OAAO,EAAET,gBAAgB,EAAEG,KAAK,CAAC,EAC1EmB,aAAa,CAACC,MAAM,EAAEI,KAAK,CAAC,CAC/B,CAAC,EAAE,CAACE,OAAO,EAAEG,KAAK,KAAK;MACpB,IAAIgB,EAAE;MACN,MAAMC,kBAAkB,GAAGZ,qBAAqB,KAAK,IAAI,IAAIA,qBAAqB,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAGA,qBAAqB,CAACL,KAAK,CAAC;MACrI,OAAOiB,kBAAkB,GACnB7C,OAAO,CAACE,MAAM,CAAC2C,kBAAkB,CAAC,GAClChD,cAAc,CAAC,CAAC+C,EAAE,GAAGH,SAAS,CAAChB,OAAO,CAAC,CAACO,GAAG,MAAM,IAAI,IAAIY,EAAE,KAAK,KAAK,CAAC,GAAGA,EAAE,GAAG,CAAC,EAAE7C,KAAK,CAAC;IACjG,CAAC,EAAEA,KAAK,CAAC,CAAC,CACb,CAAC;EACN,CAAC,SACO;IACJyC,YAAY,CAACjB,KAAK,CAAC,CAAC;EACxB;AACJ,CAAC,CAAC;AACFtC,OAAO,CAACE,cAAc,GAAGA,cAAc","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}